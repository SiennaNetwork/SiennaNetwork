# Based on https://github.com/actions-rs/example/blob/master/.github/workflows/quickstart.yml

on: [push, pull_request]

name: SIENNA CI

jobs:

  test:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2
        with:
          submodules: true

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: 1.49.0
          target: wasm32-unknown-unknown
          override: true

      - name: Run unit tests
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --locked
        env:
          RUST_BACKTRACE: 1

  coverage:
    name: Unit test coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2
        with:
          submodules: true

      - name: Install toolchain that works with Tarpaulin
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: 1.49.0
          target: wasm32-unknown-unknown
          override: true

      - name: Install Tarpaulin
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: cargo-tarpaulin
        env:
          RUST_BACKTRACE: 1

      - name: Generate test coverage
        uses: actions-rs/cargo@v1
        with:
          command: tarpaulin
          args: --out=Html --output-dir=docs
        env:
          RUST_BACKTRACE: 1

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2
        with:
          submodules: true

      - name: Install toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: 1.49.0
          target: wasm32-unknown-unknown
          override: true

      - name: Render documentation
        uses: actions-rs/cargo@v1
        with:
          command: doc
        env:
          RUST_BACKTRACE: 1

      #- name: Compile WASM contract
        #uses: actions-rs/cargo@v1
        #with:
          #command: wasm
          #args: --locked
        #env:
          #RUSTFLAGS: "-C link-arg=-s"

      #- name: Run integration tests
        #uses: actions-rs/cargo@v1
        #with:
          #command: integration-test
          #args: --locked

  #lints:
    #name: Lints
    #runs-on: ubuntu-latest
    #steps:
      #- name: Checkout sources
        #uses: actions/checkout@v2

      #- name: Install stable toolchain
        #uses: actions-rs/toolchain@v1
        #with:
          #profile: minimal
          #toolchain: 1.43.1
          #override: true
          #components: rustfmt, clippy

      #- name: Run cargo fmt
        #uses: actions-rs/cargo@v1
        #with:
          #command: fmt
          #args: --all -- --check

      #- name: Run cargo clippy
        #uses: actions-rs/cargo@v1
        #with:
          #command: clippy
          #args: -- -D warnings

      ## TODO: we should check
      ## CHANGES_IN_REPO=$(git status --porcelain)
      ## after this, but I don't know how
      #- name: Generate Schema
        #uses: actions-rs/cargo@v1
        #with:
          #command: schema
          #args: --locked
